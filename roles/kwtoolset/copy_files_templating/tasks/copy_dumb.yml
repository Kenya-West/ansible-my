- name: Gather existing file/directory ownership on path {{ item.dest}}
  ansible.builtin.stat:
    path: "{{ item.dest }}"
  register: copy_files_templating_remote_stat

- name: Copy files recursively (no templating) {{ item.src }}
  become: true
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.default_mode | default(copy_files_templating_remote_stat.stat.mode) | default('0775') }}"
    directory_mode: "{{ item.default_mode | default(copy_files_templating_remote_stat.stat.mode) | default('0775') }}"
    # Only set owner/group for remote hosts
    owner: "{{ (inventory_hostname not in ['localhost', '127.0.0.1']) | ternary(item.default_owner | default(copy_files_templating_remote_stat.stat.pw_name) | default(standard_user), omit) }}"
    group: "{{ (inventory_hostname not in ['localhost', '127.0.0.1']) | ternary(item.default_group | default(copy_files_templating_remote_stat.stat.gr_name) | default(standard_user), omit) }}"

- name: Empty variables
  ansible.builtin.set_fact:
    copy_files_templating_remote_stat: {}
  when: copy_files_templating_remote_stat is defined
