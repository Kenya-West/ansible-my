---
- name: Configure configs for btop
  hosts: general_vps_prepare
  become: false
  become_user: "{{ standard_user }}"

  vars:
    project_dir: "{{ general_vps_prepare_project_structure_end_dirs.btop | ansible.builtin.basename }}"
    project_root_dir: "{{ general_vps_prepare_project_structure_root }}"
    source_asset_rootpath_common: "{{ playbook_dir }}/assets/hosts-list/common/{{ project_root_dir }}"
    source_asset_fullpath_common: "{{ source_asset_rootpath_common }}/{{ project_dir }}"
    source_asset_rootpath_project: "{{ playbook_dir }}/assets/hosts-list/{{ inventory_hostname }}/{{ project_root_dir }}"
    source_asset_fullpath_project: "{{ source_asset_rootpath_project }}/{{ project_dir }}"
    dest_project_rootpath: "/home/{{ standard_user }}/snap/btop/current/.config/btop"
    dest_project_rootpath_root_user: "/root/snap/btop/current/.config/btop"

  tasks:
    - name: Remove btop config files in $HOME if it exists
      ansible.builtin.file:
        path: "/home/{{ standard_user }}/.config/btop"
        state: absent
      when: btop_remove_home_config | default(false)
    - name: Remove btop config files in /root if it exists
      become: true
      become_user: root
      ansible.builtin.file:
        path: "/root/.config/btop"
        state: absent
      when: btop_remove_home_config | default(false)

    - name: Check if btop is installed
      ansible.builtin.shell: command -v btop
      register: btop_path
      failed_when: btop_path.stdout == ''

    - name: Launch btop with PTY (user)
      ansible.builtin.shell: |
        script -q -c "timeout 5 btop" /dev/null || true
      when: btop_path.stdout != ''
      ignore_errors: true
    - name: Launch btop with PTY (root)
      become: true
      become_user: root
      ansible.builtin.shell: |
        script -q -c "timeout 5 btop" /dev/null || true
      when: btop_path.stdout != ''
      ignore_errors: true

    - name: Wait for snap current directory for user
      ansible.builtin.wait_for:
        path: "{{ dest_project_rootpath }}"
        state: present
        timeout: 3
      register: btop_snap_dir_user
    - name: Wait for snap current directory for root
      become: true
      become_user: root
      ansible.builtin.wait_for:
        path: "{{ dest_project_rootpath_root_user }}"
        state: present
        timeout: 3
      register: btop_snap_dir_root

    - name: Get Snap current revision for btop
      ansible.builtin.shell: snap list btop | awk 'NR==2 {print $3}'
      register: btop_snap_revision_raw
      changed_when: false
      when: btop_snap_dir_user is succeeded or btop_snap_dir_root is succeeded
      failed_when: btop_snap_revision_raw.stdout == ''
    - name: Set Snap current revision for btop
      ansible.builtin.set_fact:
        btop_snap_revision: "{{ btop_snap_revision_raw.stdout | int }}"
      when: btop_snap_revision_raw.stdout != ''
    
    - name: Check that btop snap revision directory exists for user, fail if not
      ansible.builtin.stat:
        path: "/home/{{ standard_user }}/snap/btop/{{ (btop_snap_revision | default('current')) | string }}"
      register: btop_snap_revision_dir_user
      failed_when: not btop_snap_revision_dir_user.stat.exists and (btop_snap_dir_user is succeeded)
    - name: Check that btop snap revision directory exists for root, fail if not
      become: true
      become_user: root
      ansible.builtin.stat:
        path: "/root/snap/btop/{{ (btop_snap_revision | default('current')) | string }}"
      register: btop_snap_revision_dir_root
      failed_when: not btop_snap_revision_dir_root.stat.exists and (btop_snap_dir_root is succeeded)

    - name: Set fact to use btop theme for user
      ansible.builtin.set_fact:
        btop_theme: "{{ btop_theme_user }}"
      when: btop_theme_user is defined and (btop_snap_dir_user is succeeded)
    - name: Copy config for btop from common assets
      ansible.builtin.template:
        src: "{{ source_asset_fullpath_common }}/btop.conf.j2"
        dest: "{{ dest_project_rootpath }}/btop.conf"
        owner: "{{ standard_user }}"
        group: "{{ standard_user }}"
        mode: "0775"
    - name: Set fact to use btop theme for root
      ansible.builtin.set_fact:
        btop_theme: "{{ btop_theme_root }}"
      when: btop_theme_root is defined and (btop_snap_dir_root is succeeded)
    - name: Copy config for btop from project assets
      ansible.builtin.template:
        src: "{{ source_asset_fullpath_project }}/btop.conf.j2"
        dest: "{{ dest_project_rootpath }}/btop.conf"
        owner: "{{ standard_user }}"
        group: "{{ standard_user }}"
        mode: "0775"
      ignore_errors: true

    - name: Copy config for btop from common assets to root
      become: true
      become_user: root
      ansible.builtin.template:
        src: "{{ source_asset_fullpath_common }}/btop.conf.j2"
        dest: "{{ dest_project_rootpath_root_user }}/btop.conf"
        owner: "root"
        group: "root"
        mode: "0775"
    - name: Copy config for btop from project assets to root
      become: true
      become_user: root
      ansible.builtin.template:
        src: "{{ source_asset_fullpath_project }}/btop.conf.j2"
        dest: "{{ dest_project_rootpath_root_user }}/btop.conf"
        owner: "root"
        group: "root"
        mode: "0775"
      ignore_errors: true
