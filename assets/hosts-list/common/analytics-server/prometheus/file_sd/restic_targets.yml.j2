{%- set node_list = [] -%}
{%- for host in groups['analytics_node'] -%}
  {%- set hv = hostvars[host] -%}

  {%- if (hv.get('domains_keys', {}).get('restic_rest_server') is not none) 
      or (hv.get('restic_server_proxy_server_hostname') is not none) -%}

    {# 1. Hostname fallback logic #}
    {%- set target_hostname = hv.get('restic_server_proxy_server_hostname', hv.domains_keys.restic_rest_server) -%}

    {# 2. Port fallback #}
    {%- set port = hv.get('restic_server_proxy_server_url_port', hv.restic_server_proxy_server_url_port) -%}
    {%- set final_target = target_hostname ~ (':' ~ port if port is defined else '') -%}

    {# 3. Metrics path fallback logic #}
    {%- set metrics_path = hv.get('restic_server_proxy_server_url_path', hv.restic_server_proxy_server_url_path) -%}
    {%- if not metrics_path -%}
      {%- set metrics_path = '/metrics' -%}
    {%- endif -%}

    {# 4. Build the item we will append to the list #}
    {%- set item = {
      'targets': [ final_target ],
      'labels': {
        '__metrics_path__': metrics_path
      }
    } -%}

    {# 5. Avoid duplicates if needed #}
    {%- if item not in node_list -%}
      {%- set _ = node_list.append(item) -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{{ node_list | to_nice_yaml(indent=2, sort_keys=false) }}